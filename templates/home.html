<!DOCTYPE html>
<html lang="en">
<head>


    <meta charset="UTF-8">
    <title>Home</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script
            src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous">

    </script>

    <script type="text/javascript">
        var result_data
        filename = ""

       var classification_breakpoint = 0


       function clearBox(elementID){
                                    document.getElementById(elementID).innerHTML = "";
                                    };

       function convertToCSV(objArray) {
                                var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
                                var str = '';

                                for (var i = 0; i < array.length; i++) {
                                    var line = '';
                                    for (var index in array[i]) {
                                        if (line != '') line += ','

                                        line += array[i][index];
                                        }

                                        str += line + '\r\n';
                                        }

                                        return str;
                                    }

        function ajaxOnSubmit(){clearBox('results');
                                //$(".results").append( "<p class="alert alert-success"><strong>Success!</strong> This alert box could indicate a successful or positive action.")</p>}
                                $(".results").append(`Processing the data`);}
        function ajaxOnError(){}
        function ajaxCallback(data){clearBox('results');
                                    console.log(data) ;

                                    console.log($("input[name='model_button']:checked").val());
                                    if ($("input[name='model_button']:checked").val() == 'violence'){
                                        classification_breakpoint = 0.575}
                                    else if ($("input[name='model_button']:checked").val() == 'fear'){
                                        classification_breakpoint = 0.5};
                                    console.log(classification_breakpoint);
                                    if (data.message == "no_data_uploaded_or_in_text_area_"){
                                        $(".results").append(`No data available`)}
                                    else{

                                        if (data.pred.length > 1){
                                            $(".results").append("<p>To many texts to show individual predictions </p>");
                                            $(".results").append("<p>Prediction complete, results ready for download </p>")}
                                        else{
                                            $(".results").html(`Sentiment prediction `);
                                            $(".results").append(data.pred);
                                           };
                                            $(".results").append(`<br/>`);

                                        if(data.pred.length == 1){
                                            if (data.pred > classification_breakpoint){
                                                $(".results").append(`Text classified as `)}
                                            else {
                                                $(".results").append(`Text classified as NON `)};
                                            $(".results").append($("input[name='model_button']:checked").val())};
                                        result_data = data
                                        }
                                    }

        function exportJson(el) {
                                    var data = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({"message":result_data.message,"prediction":result_data.pred}));
                                    // what to return in order to show download window?

                                    el.setAttribute("href", "data:"+data);
                                    el.setAttribute("download", "results.json");}

        function exportCSV(el) {    console.log(result_data);
                                    var csv_string = "";
                                    for (i = 0; i < result_data.message.length; i++){
                                        tt = result_data.message[i].replace(/,/g,';') // replace commas with semi-commas (, -> ;) to avoid erros in the csv
                                        csv_string += `${tt},${result_data.pred[i]}\r\n`}
                                    console.log(csv_string)

                                    var csv = csv_string
                                    console.log(csv)

                                    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                                    if (navigator.msSaveBlob) { // IE 10+
                                        navigator.msSaveBlob(blob, 'result.csv');
                                    } else {
                                        var link = document.createElement("a");
                                        if (link.download !== undefined) { // feature detection
                                            // Browsers that support HTML5 download attribute
                                            var url = URL.createObjectURL(blob);
                                            link.setAttribute("href", url);
                                            link.setAttribute("download", 'result.csv');
                                            link.style.visibility = 'hidden';
                                            document.body.appendChild(link);
                                            link.click();
                                            document.body.removeChild(link);
                                                }
                                            }
                                        }



        // {#  Modified version of ajax_form_submit for two buttons  #}
        $(document).ready(function() {
            // Hide user select form when job is changed
            let selectForm = $('#user-form');
            // User Submit form ajax handling with button instead
            $('#submitform').click(function (e) {
                let url = "{{ url_for('.predict') }}";
                ajaxOnSubmit();  // DEFINE THIS FUNC
                $.ajax({
                    type: "POST",
                    url: url,
                    data: {message: $("#message").val(), model: $("input[name='model_button']:checked").val(), filename: filename, group_result: $("input[name='result_button']:checked").val()},
                    success: function (data) {
                        ajaxCallback(data);   // DEFINE THIS FUNC
                    },
                    error: function(ajaxResponse, errorStr) {
                        ajaxOnError(ajaxResponse, errorStr);  // DEFINE THIS FUNC
                    },
                    timeout: 90*1000
                });
                e.preventDefault();
            });
        });
    </script>

<!--    // upload script-->
    <script type="text/javascript">
		$(document).ready(function (e) {
			$('#upload').on('click', function () {
				var form_data = new FormData();
				var ins = document.getElementById('multiFiles').files.length;

				if(ins == 0) {
				    filename = "";
					$('#msg').html('<span style="color:red">Select at least one file</span>');
					return;
				}

				if(ins > 1) {
				    filename = "";
					$('#msg').html('<span style="color:red">Select only one file</span>');
					return;
				}

				for (var x = 0; x < ins; x++) {
					form_data.append("files[]", document.getElementById('multiFiles').files[x]);
				}

				$.ajax({
					url: 'python-flask-files-upload', // point to server-side URL
					dataType: 'json', // what to expect back from server
					cache: false,
					contentType: false,
					processData: false,
					data: form_data,
					type: 'post',
					success: function (response) { // display success response
					    filename = response.filename ;
					    clearBox('msg');
                        $('#msg').append(response.message + '<br/>');

					},
					error: function (response) {
					    clearBox('msg');
						// $('#msg').html(response.message); // display error response
						$('#msg').append('<span style="color:red">File needs to be in CSV format</span>');
					    return;
					}
				});
			});
		});
	</script>

<!--model selection script-->

</head>

<body>
    <div class="container">
        <h4>Swedish sentiment analyser based on KB Bert</h4>


            <h6>Presented by Recorded Future and AI Sweden</h6>

        <a href="/guide" target="_blank" class="btn btn-outline-secondary btn-sm" role="button">User guide</a>

        <br/>
        <br/>
        <p>Enter a text, or a single file to the analyzer and press upload, then press predict</p>

        <div class="btn-group btn-group-toggle" data-toggle="buttons">
            <form method="POST">
            <label class="btn btn-outline-secondary btn-sm">
            <input type="radio" name="model_button" id="fear_btn" value = "fear" autocomplete="off" checked> Fear
        </label>
            <label class="btn btn-outline-secondary btn-sm">
            <input type="radio" name="model_button" id="violence_btn" value = "violence" autocomplete="off"> Violence
        </label>
        </form>
        </div>
        <p>Evaluated sentiment</p>

        <div class="btn-group btn-group-toggle" data-toggle="buttons">
            <form method="POST">
                <label class="btn btn-outline-secondary btn-sm">
                    <input type="radio" name="result_button" id="separate" value = "unsorted" autocomplete="off" checked> Unsorted
                </label>
                <label class="btn btn-outline-secondary btn-sm">
                    <input type="radio" name="result_button" id="gather" value = "sorted" autocomplete="off"> Sorted
                </label>
                <label class="btn btn-outline-secondary btn-sm">
                    <input type="radio" name="result_button" id="max" value = "max" autocomplete="off"> Max
                </label>
            </form>
        </div>
        <p>Grouping of results</p>



        <div class=" upload">
        <dl>
            <p id="msg"></p>
            <input type="file" id="multiFiles" name="files[]" multiple="multiple"/>
            <button class="btn btn-outline-secondary btn-sm" id="upload">Upload</button>
        </dl>
    </div>


    <div class="ml-container">
            <textarea name="message" rows="4" cols="50" id="message"></textarea>
            <br/>

    </div>

        <br>

    <div class="btn-group btn-group-toggle" data-toggle="buttons">
        <a  class="btn btn-outline-secondary btn-sm" id="submitform" type="button"  value="predict"  >Predict</a>
        <a  class="btn btn-outline-secondary btn-sm" id="exportJSON" onclick="exportJson(this);" ><i class="icon-download"></i> export json</a>
        <a  class="btn btn-outline-secondary btn-sm" id="exportCSV"  onclick="exportCSV(this);" ><i class="icon-download"></i> export CSV</a>
    </div>


        <div class="results" id="results">
    </div>


    </div>
</body>
</html>